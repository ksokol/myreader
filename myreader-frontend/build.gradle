plugins {
    id 'com.moowork.node' version '1.1.1'
}

apply plugin: 'java'
apply plugin: 'com.moowork.node'

node {
    version = '6.9.1'
    npmVersion = '3.10.8'
    download = true
}

jar {
    from 'dist'
    eachFile { details ->
        details.path = details.path.startsWith('META-INF') ?: 'static/' + details.path
    }
    // Jar contains duplicate empty folders, see Gradle issue:
    // http://issues.gradle.org/browse/GRADLE-1830
    // so we need to set includeEmptyDirs to false
    includeEmptyDirs = false
}

task build(type: NpmTask, dependsOn: [npm_install, test]) {
    outputs.files file('dist')
    inputs.files file('src')

    args = ['run', 'build']
}

task gulpClean(type: NpmTask) {
    outputs.files file('dist')
    inputs.files file('src')

    args = ['run', 'gulpClean']
}

task test(overwrite:true, type: NpmTask) {
    inputs.files files('src', 'test')

    args = ['test']
}

clean {
    delete "node_modules", "node"
}

clean.dependsOn gulpClean

jar.dependsOn build

sonarqube {
    properties {
        property "sonar.sources", "src"
        property "sonar.javascript.lcov.reportPath", "build/reports/istanbul/PhantomJS 2.1.1 (Linux 0.0.0)/lcov.info"
    }
}
